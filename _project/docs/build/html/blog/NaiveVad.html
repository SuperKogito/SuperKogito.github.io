<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"/><meta content="voice activity detection using short time energy" name="description"/>
<meta content="voice activity detection, vad, short time energy" name="keywords"/>
<meta content="Ayoub Malek" name="author"/>
<script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-133660046-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
<title>Naive voice activity detection using short time energy — Ayoub Malek's blog</title>
<link href="../_static/alabaster.css" rel="stylesheet" type="text/css"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
<link href="../_static/css/custom_style.css" rel="stylesheet" type="text/css"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js" type="text/javascript"></script>
<script src="../_static/jquery.js" type="text/javascript"></script>
<script src="../_static/underscore.js" type="text/javascript"></script>
<script src="../_static/doctools.js" type="text/javascript"></script>
<script src="../_static/language_data.js" type="text/javascript"></script>
<script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<link href="../_static/favicon.ico" rel="shortcut icon"/>
<link href="../about.html" rel="author" title="About these documents"/>
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="../_static/custom.css" rel="stylesheet" type="text/css"/>
<meta content="width=device-width, initial-scale=0.9, maximum-scale=0.9" name="viewport"/>
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/></head><body>
<div class="document">
<div class="documentwrapper">
<div class="body" role="main">
<!-- START Bootstrap-Cookie-Alert -->
<div class="alert text-center cookiealert" role="alert">
<div class="cookiesContainer">
<b>
                    We use cookies and other technologies to perform analytics and deliver a better user experience.
                    By clicking “I agree” below, you consent to the use by us and our third-party partners of cookies and data gathered from your use of this website.
                    See our <a href="https://cookiesandyou.com/" target="_blank">Privacy Policy</a> and <a href="https://cookiesandyou.com/" target="_blank">Third Party Partners</a> to learn more about the use of data and your rights.
                    You also agree to our <a href="https://cookiesandyou.com/" target="_blank">Terms of Service</a>.
                </b>
<button class="btn btn-primary btn-sm acceptcookies" type="button">
                    I agree
                </button>
</div>
</div>
<!-- END Bootstrap-Cookie-Alert -->
<div class="section" id="naive-voice-activity-detection-using-short-time-energy">
<h1>Naive voice activity detection using short time energy<a class="headerlink" href="#naive-voice-activity-detection-using-short-time-energy" title="Permalink to this headline">¶</a></h1><html><body><div class="sub-title-menu">
<table class="menu-table" id="menuTable" style="border:hidden;">
<tr>
<th>
</th><th>
</th><th class="icon"> <a href="../index.html" title="Home"><i class="fa fa-home"></i></a> </th>
<th class="menu-label"> <a href="../index.html" title="Home">Home</a> </th>
<th>
</th><th>
</th><th class="icon"><a href="../posts.html" title="Posts"><i class="fa fa-bars"></i></a></th>
<th class="menu-label"><a href="../posts.html" title="Posts">Posts</a></th>
<th>
</th><th>
</th><th class="icon"> <a href="../publications.html" title="pubs"><i class="fa fa-file-text"></i></a></th>
<th class="menu-label"> <a href="../publications.html" title="pubs">Publications</a></th>
<th>
</th><th>
</th><th class="icon"> <a href="../projects.html" title="projects"><i class="fa fa-code"></i></a></th>
<th class="menu-label"> <a href="../projects.html" title="projects">Projects</a></th>
<th>
</th><th>
</th><th class="icon"><a href="../about.html" title="About"><i class="fa fa-user-circle"></i></a></th>
<th class="menu-label"><a href="../about.html" title="About">About</a></th>
<th>
</th><th>
</th><th class="icon"> <a href="#" onclick="modeSwitcher()"><i class="fa fa-adjust"></i></a></th>
<th class="menu-label"> <a href="#" onclick="modeSwitcher()"><text id="theme-toggle">DARK MODE</text></a></th>
</tr>
</table>
</div>
</body></html>
<div class="blog-post-tags">
<ul class="blog-posts-details">
<li id="Date"><span>Date:</span>                 09 February 2020 </li>
<li id="author"><span>Author:</span> <a href="author/ayoub-malek.html">Ayoub Malek</a> </li>
<li id="location"><span>Location:</span> <a href="location/munich.html">Munich</a>
</li> <li id="language"><span>Language:</span> <a href="language/english.html">English</a>
</li> <li id="category"><span>Category:</span> <a href="category/signal-processing.html"> Signal processing</a>
</li>
<li id="tags"><span>Tags:
        </span>
<a class="post-tags" href="tag/audio.html">Audio</a>
<a class="post-tags" href="tag/vad.html">VAD</a>
<a class="post-tags" href="tag/python.html">Python</a>
</li>
</ul>
</div><hr class="docutils"/>
<p>An important part of speech/speaker recognition tasks is distinction of voiced segments from silent ones.
This helps -for example- align phonemes with their associated voiced segments and avoid any extra information related to silence/ noise that would degrade the system’s accuracy.
This problem is known as Voice Activity Detection (VAD). This blog aims to introduce voice activity detection and present simple short time energy based VAD implementation.</p>
<div class="section" id="what-is-voice-activity-detection">
<h2>What is voice activity detection ?<a class="headerlink" href="#what-is-voice-activity-detection" title="Permalink to this headline">¶</a></h2>
<p>Voice activity detection is a speech/signal processing technique in which the presence or absence of human speech is detected.
VAD is often used in speech coding and speech recognition but it also helps optimize and speed audio dependent approach like speaker recognition.</p>
</div>
<div class="section" id="why-do-we-do-need-voice-activity-detection">
<h2>Why do we do need voice activity detection?<a class="headerlink" href="#why-do-we-do-need-voice-activity-detection" title="Permalink to this headline">¶</a></h2>
<p>As mentioned before VAD is very useful in many audio processing related tasks. A couple of these uses are highlighted in the following list:</p>
<ul class="simple">
<li><p>In speech recognition, VAD helps improve the quality by masking the effect of silent frames and noise.</p></li>
<li><p>In Speech enhancement, VAD can be used to collect silent frames to get a good noise estimation for example.</p></li>
<li><p>In Speaker recognition, VAD allows for better quality detection since the recognition will be based only on “pure” speech frames.</p></li>
<li><p>In many other applications, VAD is used to accelerate the processing and avoid extra runs for silent frames.</p></li>
</ul>
</div>
<div class="section" id="how-to-implement-it">
<h2>How to implement it?<a class="headerlink" href="#how-to-implement-it" title="Permalink to this headline">¶</a></h2>
<p>The basic assumption behind short time energy based VAD is that voiced frames has more energy than silent.
Therefore, we can frame the signal, compute the short time energy aka the energy pro frame and according to a predefined threshold we can decide where the frame is voiced or silent <a class="bibtex reference internal" href="#tom2019" id="id1">[Bac19]</a>.
These steps can be summarized in the following:</p>
<ul>
<li><p><strong>Frame signal</strong> (refer to <a class="reference external" href="SignalFraming.html">Signal_framing</a>).</p>
<p>Assuming a signal <span class="math notranslate nohighlight">\(S\)</span>, this can be formulated as follows: <span class="math notranslate nohighlight">\(S = \sum_{n=0}^{N_s-1} x[n] = \sum_{i=0}^{\#F-1} f[i]\)</span> where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(S\)</span>: Discrete signal.</p></li>
<li><p><span class="math notranslate nohighlight">\(x[n]\)</span>: Signal sample in time domain.</p></li>
<li><p><span class="math notranslate nohighlight">\(N_s\)</span> : Signal length in samples.</p></li>
<li><p><span class="math notranslate nohighlight">\(f[i]\)</span>: Signal frame.</p></li>
<li><p><span class="math notranslate nohighlight">\(\#F\)</span> : Number of frames.</p></li>
</ul>
</li>
<li><p><strong>Compute the energy per frame aka short time energy.</strong></p>
<p>The short time energy can be assumed to be the total energy of each.
The energy pro frame is <span class="math notranslate nohighlight">\(E_f = \sum_{n=0}^{N_f - 1} |x[n]|^2\)</span>, and consequently the normalized short time energy value, is <span class="math notranslate nohighlight">\(\overline{E}_f = \frac{1}{N_f - 1}.\sum_{n=0}^{N_f - 1} |x[n]|^2\)</span>.
Based on the <a class="reference external" href="https://en.wikipedia.org/wiki/Discrete_Fourier_transform">Parseval’s theorem</a>, we can use the <a href="#id4"><span class="problematic" id="id5">Discrete_Fourrier_transform_</span></a> to compute the energy since: <span class="math notranslate nohighlight">\(\sum_{n=0}^{N_f - 1} |x[n]|^2 = \frac{1}{N_f - 1}.\sum_{n=0}^{N_f - 1} |X[n]|^2\)</span>.
To summarize: <span class="math notranslate nohighlight">\(\overline{E}_f = \frac{1}{(N_f - 1)^2}.\sum_{n=0}^{N_f - 1} |X[n]|^2\)</span></p>
<p>with:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(E_f[n]\)</span>: Frame total energy.</p></li>
<li><p><span class="math notranslate nohighlight">\(\overline{E}_f[n]\)</span>: Normalized frame total energy.</p></li>
<li><p><span class="math notranslate nohighlight">\(x[n]\)</span>: Signal sample in the time domain.</p></li>
<li><p><span class="math notranslate nohighlight">\(X[n]\)</span>: Signal sample in the frequency domain.</p></li>
<li><p><span class="math notranslate nohighlight">\(N_f\)</span> : Frame length in samples.</p></li>
<li><p><span class="math notranslate nohighlight">\(F[i]\)</span>: Signal frame.</p></li>
<li><p><span class="math notranslate nohighlight">\(\#F\)</span> : Number of frames.</p></li>
</ul>
<p>A standard practice is to convert the computed energy to Decibels using a suitably chosen <span class="math notranslate nohighlight">\(E_0\)</span> (Energy value characterizing the silence to speech energy ratio):</p>
<div class="math notranslate nohighlight">
\begin{equation}
    \overline{E}_{f_{dB}} = 10 ⋅ \log_{10}(\frac{\overline{E}_f}{E_0})
\end{equation}</div></li>
<li><p><strong>Construct VAD array using threshold comparison the energy.</strong></p>
<p>By comparing the short time energy values to a predefined energy threshold, we compute the VAD as follows:</p>
<div class="math notranslate nohighlight">
\begin{equation}
  VAD[n]=\left\{\begin{array}{ll}
      {0,} &amp; {\overline{E}_f[n] \leq    threshold \implies Silence} \\
      {1,} &amp; {\overline{E}_f[n] &gt;       threshold \implies Speech}
  \end{array}\right.
\end{equation}</div><p>with:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(VAD[n]\)</span>: The Voice Activity Detection array.</p></li>
<li><p><span class="math notranslate nohighlight">\(\overline{E}_f[n]\)</span>: Normalized frame total energy.</p></li>
</ul>
</li>
<li><p><strong>Compute the voiced Signal.</strong></p>
<div class="math notranslate nohighlight">
\begin{equation}
  \widetilde{S}[n]= S[n] . VAD[n]
\end{equation}</div><p>with:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\widetilde{S}[n]\)</span>: Silence filtered signal.</p></li>
<li><p><span class="math notranslate nohighlight">\(VAD[n]\)</span>: The Voice Activity Detection array.</p></li>
<li><p><span class="math notranslate nohighlight">\(S[n]\)</span> : The original signal.</p></li>
</ul>
</li>
</ul>
<p>The code for the previous steps is the following (I added a visualization function to help visualize the concept):</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Framing 1</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">scipy.io.wavfile</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="k">def</span> <span class="nf">stride_trick</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">stride_length</span><span class="p">,</span> <span class="n">stride_step</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    apply framing using the stride trick from numpy.</span>

<span class="sd">    Args:</span>
<span class="sd">        a (array) : signal array.</span>
<span class="sd">        stride_length (int) : length of the stride.</span>
<span class="sd">        stride_step (int) : stride step.</span>

<span class="sd">    Returns:</span>
<span class="sd">        blocked/framed array.</span>
<span class="sd">    """</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">stride_length</span><span class="p">)</span> <span class="o">//</span> <span class="n">stride_step</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span><span class="n">a</span><span class="p">,</span>
                                           <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">stride_length</span><span class="p">),</span>
                                           <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">stride_step</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">framing</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">16000</span><span class="p">,</span> <span class="n">win_len</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">win_hop</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    transform a signal into a series of overlapping frames (=Frame blocking).</span>

<span class="sd">    Args:</span>
<span class="sd">        sig     (array) : a mono audio signal (Nx1) from which to compute features.</span>
<span class="sd">        fs        (int) : the sampling frequency of the signal we are working with.</span>
<span class="sd">                          Default is 16000.</span>
<span class="sd">        win_len (float) : window length in sec.</span>
<span class="sd">                          Default is 0.025.</span>
<span class="sd">        win_hop (float) : step between successive windows in sec.</span>
<span class="sd">                          Default is 0.01.</span>

<span class="sd">    Returns:</span>
<span class="sd">        array of frames.</span>
<span class="sd">        frame length.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">        Uses the stride trick to accelerate the processing.</span>
<span class="sd">    """</span>
    <span class="c1"># run checks and assertions</span>
    <span class="k">if</span> <span class="n">win_len</span> <span class="o">&lt;</span> <span class="n">win_hop</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">"ParameterError: win_len must be larger than win_hop."</span><span class="p">)</span>

    <span class="c1"># compute frame length and frame step (convert from seconds to samples)</span>
    <span class="n">frame_length</span> <span class="o">=</span> <span class="n">win_len</span> <span class="o">*</span> <span class="n">fs</span>
    <span class="n">frame_step</span> <span class="o">=</span> <span class="n">win_hop</span> <span class="o">*</span> <span class="n">fs</span>
    <span class="n">signal_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
    <span class="n">frames_overlap</span> <span class="o">=</span> <span class="n">frame_length</span> <span class="o">-</span> <span class="n">frame_step</span>

    <span class="c1"># compute number of frames and left sample in order to pad if needed to make</span>
    <span class="c1"># sure all frames have equal number of samples  without truncating any samples</span>
    <span class="c1"># from the original signal</span>
    <span class="n">rest_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">signal_length</span> <span class="o">-</span> <span class="n">frames_overlap</span><span class="p">)</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frame_length</span> <span class="o">-</span> <span class="n">frames_overlap</span><span class="p">)</span>
    <span class="n">pad_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame_step</span> <span class="o">-</span> <span class="n">rest_samples</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">rest_samples</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">)))</span>

    <span class="c1"># apply stride trick</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="n">stride_trick</span><span class="p">(</span><span class="n">pad_signal</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame_length</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame_step</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">frames</span><span class="p">,</span> <span class="n">frame_length</span>


<span class="k">def</span> <span class="nf">_calculate_normalized_short_time_energy</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>


<span class="k">def</span> <span class="nf">naive_frame_energy_vad</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=-</span><span class="mi">20</span><span class="p">,</span> <span class="n">win_len</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">win_hop</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">E0</span><span class="o">=</span><span class="mf">1e7</span><span class="p">):</span>
    <span class="c1"># framing</span>
    <span class="n">frames</span><span class="p">,</span> <span class="n">frames_len</span> <span class="o">=</span> <span class="n">framing</span><span class="p">(</span><span class="n">sig</span><span class="o">=</span><span class="n">sig</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">win_len</span><span class="o">=</span><span class="n">win_len</span><span class="p">,</span> <span class="n">win_hop</span><span class="o">=</span><span class="n">win_hop</span><span class="p">)</span>

    <span class="c1"># compute short time energies to get voiced frames</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">_calculate_normalized_short_time_energy</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
    <span class="n">log_energy</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">energy</span> <span class="o">/</span> <span class="n">E0</span><span class="p">)</span>

    <span class="c1"># normalize energy to 0 dB then filter and format</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">medfilt</span><span class="p">(</span><span class="n">log_energy</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">frames_len</span><span class="p">)</span>

    <span class="c1"># compute vad and get speech frames</span>
    <span class="n">vad</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sig</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">vframes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frames</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vad</span><span class="o">==</span><span class="mi">1</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sig</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">energy</span><span class="p">,</span> <span class="n">vad</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vframes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">multi_plots</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">titles</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">plot_rows</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s2">"b"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"g"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">]):</span>
    <span class="c1"># first fig</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">plot_rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.125</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plot_rows</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">plot_rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="o">/</span><span class="n">fs</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">step</span><span class="p">)],</span> <span class="n">y</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># second fig</span>
    <span class="n">sig</span><span class="p">,</span> <span class="n">vad</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># plot VAD and orginal signal</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="o">/</span><span class="n">fs</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">))],</span> <span class="n">sig</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Signal"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="o">/</span><span class="n">fs</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vad</span><span class="p">))],</span> <span class="nb">max</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">*</span><span class="n">vad</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"VAD"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'best'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="c1"># init vars</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s2">"OSR_us_000_0060_8k.wav"</span>
    <span class="n">fs</span><span class="p">,</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">wavfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="c1">#########################</span>
    <span class="c1"># naive_frame_energy_vad</span>
    <span class="c1">#########################</span>
    <span class="c1"># get voiced frames</span>
    <span class="n">energy</span><span class="p">,</span> <span class="n">vad</span><span class="p">,</span> <span class="n">voiced</span> <span class="o">=</span> <span class="n">naive_frame_energy_vad</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=-</span><span class="mi">35</span><span class="p">,</span>
                                                 <span class="n">win_len</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">win_hop</span><span class="o">=</span><span class="mf">0.025</span><span class="p">)</span>

    <span class="c1"># plot results</span>
    <span class="n">multi_plots</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">sig</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">vad</span><span class="p">,</span> <span class="n">voiced</span><span class="p">],</span>
                <span class="n">titles</span><span class="o">=</span><span class="p">[</span><span class="s2">"Input signal (voiced + silence)"</span><span class="p">,</span> <span class="s2">"Short time energy"</span><span class="p">,</span>
                        <span class="s2">"Voice activity detection"</span><span class="p">,</span> <span class="s2">"Output signal (voiced only)"</span><span class="p">],</span>
                <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">plot_rows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># save voiced signal</span>
    <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">wavfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"naive_frame_energy_vad_no_silence_"</span><span class="o">+</span> <span class="n">fname</span><span class="p">,</span>
                           <span class="n">fs</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">voiced</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sig</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
<p>The resulting plots clearly show a good performance of this simple and fast VAD.</p>
<a class="reference internal image-reference" href="../_images/naive_vad_multi_plots.png"><img alt="../_images/naive_vad_multi_plots.png" class="align-center" src="../_images/naive_vad_multi_plots.png" style="width: 1040.3999999999999px; height: 428.4px;"/></a>
<center><a href="../figures/fig17.html">Figure 17: Summary plots of voice activity detection</a> </center>
</div><a class="reference internal image-reference" href="../_images/vad_and_signal.png"><img alt="../_images/vad_and_signal.png" class="align-center" src="../_images/vad_and_signal.png" style="width: 918.0px; height: 306.0px;"/></a>
<center><a href="../figures/fig18.html">Figure 18: Voice activity detection and original signal</a> </center>
</div><div class="line-block">
<div class="line"><br/></div>
</div>
<p>I already tested the VAD using the following <a class="reference external" href="https://www.voiptroubleshooter.com/open_speech/american/OSR_us_000_0060_8k.wav">sample</a> that can be downloaded from <a class="reference external" href="https://www.voiptroubleshooter.com/open_speech/american.html">Open Speech Repository</a>.
The difference between the input and output shows that the VAD is functional.</p>
<table class="docutils align-default">
<tr>
<th class="centeredth">Input signal (voiced and silent frames) </th>
<th class="centeredth">Output signal (voiced only frames)</th>
</tr>
<tr>
<td class="centeredth">
<audio controls="" style="width: 450px;">
<source src="../_static/audio/OSR_us_000_0060_8k.wav" type="audio/wav">
     Your browser does not support the audio element.
   </source></audio>
</td>
<td class="centeredth">
<audio controls="" style="width: 450px;">
<source src="../_static/audio/naive_frame_energy_vad_no_silence_OSR_us_000_0060_8k.wav" type="audio/wav">
     Your browser does not support the audio element.
   </source></audio>
</td>
</tr>
</table></div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>This blog gave a quick overview to voice activity detection and its use in practical speech/ signal processing applications.
It also introduced a naive simple way to distinguish silence from speech using short time energy.
This type of VAD, though it is fast &amp; simple, it lacks accuracy in some cases as it is dependent on the manual choice of threshold and  <span class="math notranslate nohighlight">\(E_0\)</span> (Energy value characterizing the silence to speech energy ratio).
Therefore, it is advised to equalize the input audio before the processing. Alternative approaches to VAD uses extra features such as MFCCs and are based on machine learning algorithms.</p>
</div>
<div class="section" id="references-and-further-readings">
<h2>References and Further readings<a class="headerlink" href="#references-and-further-readings" title="Permalink to this headline">¶</a></h2>
<p id="bibtex-bibliography-blog/NaiveVad-0"></p><dl class="citation">
<dt class="bibtex label" id="tom2019"><span class="brackets"><a class="fn-backref" href="#id1">Bac19</a></span></dt>
<dd><p>Tom Bäckström. Voice activity detection (vad). <em>Introduction to Speech Processing</em>, 2019. [Online; accessed 09.02.2020]. URL: <a class="reference external" href="https://wiki.aalto.fi/pages/viewpage.action?pageId=151500905">https://wiki.aalto.fi/pages/viewpage.action?pageId=151500905</a>.</p>
</dd>
</dl>
</div>
</div>
<div class="section">
<div class="section">
<span style="float: left">
     Previous:
    
    <a href="SignalFraming.html">
       Signal framing
    </a>
</span>
<span> </span>
<span style="float: right">
     Next: 
    <a href="SpectralLeakageWindowing.html">
      Spectral leakage and windowing 
    </a>
</span>
</div>
</div>
</div>
<div class="clearer"></div>
<div class="footer">
      ©2019-2021, Ayoub Malek.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      | <a href="https://github.com/bitprophet/alabaster">Terms of Service</a>
      | <a href="https://github.com/bitprophet/alabaster">Privacy Policy</a>
      | <a href="https://github.com/bitprophet/alabaster">Impressum</a>
</div><html><head><script async="" defer="" src="https://buttons.github.io/buttons.js"></script></head></html><html><head><script src="../_static/js/mode-switcher.js"></script></head></html>
<!-- Include cookiealert script -->
<script src="https://cdn.jsdelivr.net/gh/Wruczek/Bootstrap-Cookie-Alert@gh-pages/cookiealert.js"></script>
<script src="_static/js/share-buttons.js"></script>
</body>
</html>